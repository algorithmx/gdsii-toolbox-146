# PDK to Layer Configuration Converter

This directory contains a comprehensive converter system for transforming various PDK file formats into layer configuration JSON files compatible with the GDSII-to-STEP conversion workflow.

## Overview

The converter system provides two main functions:

1. **`gds_convert_lyp_lyt_to_config.m`** - Specialized converter for KLayout LYP and LYT files
2. **`gds_convert_pdk_to_config.m`** - Universal converter supporting multiple PDK formats

Both converters generate JSON layer configuration files that are fully compatible with `gds_read_layer_config()` and the GDSII-to-3D conversion workflow.

## Supported Input Formats

### KLayout Files
- **LYP files** (Layer Properties): XML or text format with layer colors, names, and visibility
- **LYT files** (Layer Technology): Technology files with thickness and z-height information

### Industry Standard Formats
- **LEF files** (Library Exchange Format): Technology LEF with layer definitions and routing rules
- **MAP files** (GDSII Layer Maps): Text files mapping GDSII layer/datatype to layer names
- **XS files** (Cross-Section Scripts): KLayout Ruby scripts with process stack information

### Generic Formats
- **CSV files**: Tabular layer parameters with columns for layer names, GDSII numbers, thickness, etc.
- **Tech files**: Generic text-based technology specifications

## Usage Examples

### Basic LYP/LYT Conversion

```matlab
% Convert KLayout LYP and LYT files
config = gds_convert_lyp_lyt_to_config('sg13g2.lyp', 'sg13g2.lyt', ...
                                      'output_file', 'layer_config_sg13g2.json', ...
                                      'project_name', 'IHP SG13G2 Process', ...
                                      'foundry', 'IHP', ...
                                      'process', 'SG13G2');
```

### Universal PDK Conversion

```matlab
% Convert multiple PDK sources
config = gds_convert_pdk_to_config('lyp_file', 'tech.lyp', ...
                                  'lef_file', 'tech.lef', ...
                                  'map_file', 'layers.map', ...
                                  'csv_file', 'layers.csv', ...
                                  'output_file', 'layer_config_unified.json', ...
                                  'project_name', 'Multi-Source PDK');
```

### LEF-Only Conversion

```matlab
% Convert only LEF technology file
config = gds_convert_pdk_to_config('lef_file', 'tech.lef', ...
                                  'output_file', 'layer_config_from_lef.json');
```

## Output Format

The generated JSON files follow the layer configuration specification used by `gds_read_layer_config()`:

```json
{
  "project": "Process Name",
  "units": "micrometers",
  "foundry": "Foundry Name",
  "process": "Process Technology",
  "version": "1.0",
  "author": "Generated by gdsii-toolbox",
  "date": "2025-10-13",
  "notes": "Generated from PDK sources",

  "conversion_options": {
    "substrate_thickness": 10.0,
    "passivation_thickness": 0.5,
    "merge_vias_with_metals": false,
    "simplify_polygons": 0.01,
    "tolerance": 1e-6
  },

  "layers": [
    {
      "gds_layer": 8,
      "gds_datatype": 0,
      "name": "Metal1",
      "description": "Metal layer 1",
      "z_bottom": 0.8,
      "z_top": 1.3,
      "thickness": 0.5,
      "material": "Aluminum",
      "color": "#39BFFF",
      "opacity": 1.0,
      "enabled": true,
      "fill_type": "solid",
      "properties": {}
    }
  ]
}
```

## Feature Highlights

### Intelligent Data Merging
- **Priority System**: Explicit specifications > automatic detection > defaults
- **Cross-Reference**: Multiple sources are cross-referenced for consistency
- **Conflict Resolution**: Warnings for conflicts with automatic resolution
- **Gap Filling**: Missing information is filled with intelligent defaults

### Material Assignment
- **Pattern Recognition**: Automatic material assignment based on layer naming
- **Industry Standards**: Follows common semiconductor material conventions
- **Custom Override**: Manual material specifications override automatic assignment

### Z-Height Calculation
- **Multiple Sources**: LYT files, XS scripts, LEF files, or estimation
- **Consistency Validation**: Ensures z_top - z_bottom = thickness
- **Process Stack**: Logical layer ordering based on semiconductor process

### Error Handling
- **Graceful Degradation**: Missing files are handled gracefully
- **Parse Resilience**: Malformed sections are skipped with warnings
- **Validation**: Final output is validated for consistency

## Layer Configuration Without KLayout

When working without KLayout, layer configuration typically comes from these sources:

### 1. Technology LEF Files
```lef
LAYER Metal1
  TYPE ROUTING ;
  DIRECTION HORIZONTAL ;
  PITCH 0.14 ;
  WIDTH 0.06 ;
  THICKNESS 0.5 ;
END Metal1
```

### 2. Cross-Section Scripts
```ruby
# Layer thickness definitions
$t_metal1 = 0.5
$t_metal2 = 0.5

# Z-height definitions
$z_metal1_bottom = 0.8
$z_metal1_top = 1.3
```

### 3. GDSII Layer Maps
```
# Format: GDS_LAYER GDS_DATATYPE LAYER_NAME
8   0   Metal1
10  0   Metal2
19  0   Via1
```

### 4. Process Design Rules
- **PDF Documentation**: Layer stack diagrams and specifications
- **CSV Tables**: Extracted parameters from design manuals
- **Vendor Databases**: Technology-specific information

## Testing

### Run Test Suite
```matlab
% Run all tests
test_pdk_converter();

% Run tests quietly
test_pdk_converter('verbose', false);

% Create test fixture files
test_pdk_converter('create_fixtures', true);
```

### Test Categories
1. **Basic Functionality**: Core conversion operations
2. **File Format Parsing**: Each supported format
3. **Data Merging**: Multi-source integration
4. **Error Handling**: Edge cases and error conditions
5. **Workflow Integration**: Compatibility with existing tools
6. **Edge Cases**: Boundary conditions and special cases

## Examples

See `examples/pdk_converter_examples.m` for comprehensive usage examples:

- Basic LYP/LYT conversion
- Multi-source PDK conversion
- LEF file processing
- Custom CSV configurations
- Workflow integration

## File Structure

```
Export/
├── gds_convert_lyp_lyt_to_config.m    # LYP/LYT specialized converter
├── gds_convert_pdk_to_config.m        # Universal PDK converter
├── examples/
│   └── pdk_converter_examples.m       # Usage examples
├── new_tests/
│   ├── test_pdk_converter.m           # Test suite
│   └── fixtures/
│       └── pdk_converter/             # Test fixture files
└── docs/
    └── PDK_CONVERTER_README.md        # This documentation
```

## Integration with GDSII-to-STEP Workflow

The generated configuration files integrate seamlessly with the existing GDSII-to-STEP conversion workflow:

```matlab
% 1. Convert PDK to layer configuration
gds_convert_pdk_to_config('lyp_file', 'tech.lyp', ...
                         'lef_file', 'tech.lef', ...
                         'output_file', 'layer_config.json');

% 2. Load configuration for 3D conversion
cfg = gds_read_layer_config('layer_config.json');

% 3. Use in GDSII-to-3D workflow
glib = read_gds_library('design.gds');
layer_data = gds_layer_to_3d(glib, cfg);
```

## Common PDK Sources

### Open Source PDKs
- **IHP SG13G2**: 130nm BiCMOS process
- **SkyWater Sky130**: 130nm CMOS process
- **Google/SkyWater 130nm**: Open source process
- **Efabless MPW-1 180nm**: Open source process

### Commercial PDKs
- **TSMC**: Various process nodes (28nm, 40nm, 65nm, etc.)
- **GlobalFoundries**: 22FDX, 12FDX, etc.
- **Samsung**: FinFET processes
- **Intel**: Advanced process nodes

## Troubleshooting

### Common Issues

1. **Missing Input Files**
   - Ensure file paths are correct
   - Check file permissions
   - Verify file format compatibility

2. **Parse Errors**
   - Check for malformed XML in LYP files
   - Verify CSV formatting
   - Validate LEF syntax

3. **Inconsistent Layer Data**
   - Check for conflicting layer numbers
   - Verify thickness/z-height consistency
   - Review material assignments

4. **Empty Output**
   - Verify input files contain layer data
   - Check for parsing warnings
   - Validate file format detection

### Debug Mode
Enable verbose output for detailed debugging:
```matlab
config = gds_convert_pdk_to_config('lyp_file', 'tech.lyp', 'verbose', true);
```

## Contributing

To add support for new PDK formats:

1. **Add Parser Function**: Create `parse_<format>_file()` function
2. **Update Universal Converter**: Add format to `gds_convert_pdk_to_config()`
3. **Add Tests**: Create test cases in `test_pdk_converter.m`
4. **Update Documentation**: Add format description to this README

## License

This converter system is part of the gdsii-toolbox-146 project and follows the same licensing terms as the main project.